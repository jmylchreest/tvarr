openapi: 3.0.3
info:
  title: EPG Timezone & Canvas API Updates
  description: |
    API changes for EPG timezone normalization and canvas layout fix.

    This feature does NOT introduce new endpoints - it documents the existing
    endpoints used for lazy loading and clarifies the timezone normalization
    behavior that occurs during ingestion.
  version: 1.0.0

paths:
  /api/v1/epg/guide:
    get:
      operationId: getEpgGuide
      summary: Get EPG TV guide
      description: |
        Returns EPG data formatted for TV guide display with channels and programs.

        Used by the frontend for lazy loading - call with different time ranges
        to load additional data as user scrolls.

        **Lazy Loading Pattern:**
        1. Initial load: `start_time=now`, `end_time=now+12h`
        2. When user scrolls within 2 hours of `end_time`: fetch next chunk
        3. Next load: `start_time=previous_end_time`, `end_time=previous_end_time+12h`

        **Timezone Handling:**
        All times returned are in UTC. The frontend should convert to local time
        for display. The "now" indicator uses current UTC time for comparison.
      tags:
        - EPG
      parameters:
        - name: start_time
          in: query
          description: |
            Start of time range (RFC3339 format, UTC).
            Defaults to current hour if not specified.
          schema:
            type: string
            format: date-time
          example: "2025-12-14T12:00:00Z"
        - name: end_time
          in: query
          description: |
            End of time range (RFC3339 format, UTC).
            Defaults to start_time + 12 hours if not specified.
          schema:
            type: string
            format: date-time
          example: "2025-12-15T00:00:00Z"
        - name: source_id
          in: query
          description: Comma-separated EPG source IDs to filter by
          schema:
            type: string
          example: "01HGW2QKT123,01HGW2QKT456"
      responses:
        '200':
          description: EPG guide data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuideResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/epg-sources/{id}:
    get:
      operationId: getEpgSource
      summary: Get EPG source details
      description: |
        Returns EPG source configuration including detected timezone.

        The `detected_timezone` field shows the timezone automatically detected
        from the upstream EPG data during the last ingestion. This is read-only
        and used for reference.

        The `epg_shift` field allows manual adjustment (in hours) applied after
        UTC normalization.
      tags:
        - EPG Sources
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: EPG source ULID
      responses:
        '200':
          description: EPG source details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EpgSourceResponse'
        '404':
          description: EPG source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      operationId: updateEpgSource
      summary: Update EPG source
      description: |
        Update EPG source configuration.

        The `epg_shift` field can be modified to apply manual time adjustment.
        After updating, trigger a re-ingestion to apply the new shift.

        The `detected_timezone` field is read-only and cannot be modified via API.
      tags:
        - EPG Sources
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EpgSourceUpdateRequest'
      responses:
        '200':
          description: EPG source updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EpgSourceResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: EPG source not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    GuideResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/GuideData'

    GuideData:
      type: object
      properties:
        channels:
          type: object
          description: Map of channel_id to channel info
          additionalProperties:
            $ref: '#/components/schemas/GuideChannelInfo'
        programs:
          type: object
          description: Map of channel_id to array of programs
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/GuideProgramInfo'
        time_slots:
          type: array
          description: Hourly time slot markers (RFC3339)
          items:
            type: string
            format: date-time
        start_time:
          type: string
          format: date-time
          description: Guide start time (UTC)
        end_time:
          type: string
          format: date-time
          description: Guide end time (UTC)

    GuideChannelInfo:
      type: object
      properties:
        id:
          type: string
          description: EPG channel ID (tvg_id)
        database_id:
          type: string
          description: Database channel ULID for streaming
        name:
          type: string
          description: Channel display name
        logo:
          type: string
          description: Channel logo URL
        stream_url:
          type: string
          description: Upstream stream URL

    GuideProgramInfo:
      type: object
      properties:
        id:
          type: string
          description: Program ULID
        channel_id:
          type: string
          description: EPG channel ID
        channel_name:
          type: string
        channel_logo:
          type: string
        title:
          type: string
          description: Program title (searchable)
        description:
          type: string
          description: Program description (searchable)
        start_time:
          type: string
          format: date-time
          description: Program start time (UTC)
        end_time:
          type: string
          format: date-time
          description: Program end time (UTC)
        category:
          type: string
        rating:
          type: string
        source_id:
          type: string
        is_live:
          type: boolean
          description: True if program is currently airing

    EpgSourceResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/EpgSource'

    EpgSource:
      type: object
      properties:
        id:
          type: string
          description: EPG source ULID
        name:
          type: string
          description: User-friendly source name
        type:
          type: string
          enum: [xmltv, xtream]
        url:
          type: string
          description: Source URL
        detected_timezone:
          type: string
          description: |
            Auto-detected timezone offset from EPG data (read-only).
            Format: "+HH:MM" or "-HH:MM" or empty for UTC.
            Examples: "+01:00", "-05:00", "+00:00"
          example: "+01:00"
        epg_shift:
          type: integer
          description: |
            Manual time shift in hours applied after UTC normalization.
            Positive values shift times forward, negative shift backward.
            Range: -12 to +12
          minimum: -12
          maximum: 12
          example: 0
        status:
          type: string
          enum: [pending, ingesting, success, failed]
        program_count:
          type: integer
          description: Number of programs from last ingestion
        last_ingestion_at:
          type: string
          format: date-time
        last_error:
          type: string

    EpgSourceUpdateRequest:
      type: object
      properties:
        name:
          type: string
        url:
          type: string
        epg_shift:
          type: integer
          description: Manual time shift in hours (-12 to +12)
          minimum: -12
          maximum: 12
        enabled:
          type: boolean

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
        detail:
          type: string
          description: Detailed error information

tags:
  - name: EPG
    description: EPG browsing and guide endpoints
  - name: EPG Sources
    description: EPG source configuration
