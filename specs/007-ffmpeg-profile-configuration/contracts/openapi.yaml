# OpenAPI 3.0 Specification - FFmpeg Profile Configuration
# Feature: 007-ffmpeg-profile-configuration
# These endpoints extend the existing /api/v1/relay-profiles endpoints

openapi: 3.0.3
info:
  title: Tvarr API - FFmpeg Profile Configuration Extensions
  version: 1.0.0
  description: |
    API extensions for FFmpeg profile configuration, testing, and preview.
    These endpoints extend the existing relay profile management API.

servers:
  - url: /api/v1
    description: API v1

paths:
  /relay-profiles:
    get:
      summary: List all relay profiles
      description: Returns all relay profiles including custom flags and HW accel configuration
      operationId: listRelayProfiles
      tags:
        - Relay Profiles
      responses:
        '200':
          description: List of relay profiles
          content:
            application/json:
              schema:
                type: object
                properties:
                  profiles:
                    type: array
                    items:
                      $ref: '#/components/schemas/RelayProfile'
                  count:
                    type: integer

    post:
      summary: Create a new relay profile
      description: Creates a custom relay profile with optional custom flags
      operationId: createRelayProfile
      tags:
        - Relay Profiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRelayProfileRequest'
      responses:
        '201':
          description: Profile created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelayProfile'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /relay-profiles/{id}:
    get:
      summary: Get a relay profile
      operationId: getRelayProfile
      tags:
        - Relay Profiles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Relay profile details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelayProfile'
        '404':
          description: Profile not found

    put:
      summary: Update a relay profile
      description: Updates a custom profile. System profiles can only toggle enabled flag.
      operationId: updateRelayProfile
      tags:
        - Relay Profiles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRelayProfileRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelayProfile'
        '400':
          description: Validation error
        '403':
          description: Cannot modify system profile
        '404':
          description: Profile not found

    delete:
      summary: Delete a relay profile
      description: Deletes a custom profile. System profiles cannot be deleted.
      operationId: deleteRelayProfile
      tags:
        - Relay Profiles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Profile deleted
        '403':
          description: Cannot delete system profile
        '404':
          description: Profile not found
        '409':
          description: Profile in use by proxies

  /relay-profiles/{id}/clone:
    post:
      summary: Clone a relay profile (FR-012)
      description: Creates an editable copy of any profile (system or custom)
      operationId: cloneRelayProfile
      tags:
        - Relay Profiles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  description: Name for the cloned profile
                  maxLength: 100
                  example: "My Custom Profile (Copy)"
      responses:
        '201':
          description: Profile cloned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelayProfile'
        '400':
          description: Invalid name or name already exists
        '404':
          description: Source profile not found

  /relay-profiles/{id}/test:
    post:
      summary: Test a relay profile (FR-016)
      description: |
        Tests the profile against a sample stream URL.
        Returns detailed results including hardware acceleration verification.
        Times out after 30 seconds.
      operationId: testRelayProfile
      tags:
        - Relay Profiles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - test_stream_url
              properties:
                test_stream_url:
                  type: string
                  format: uri
                  description: URL of the stream to test against
                  example: "http://example.com/stream.m3u8"
                test_duration_seconds:
                  type: integer
                  description: Duration of the test in seconds (default 5, max 30)
                  minimum: 1
                  maximum: 30
                  default: 5
      responses:
        '200':
          description: Test completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileTestResult'
        '400':
          description: Invalid test parameters
        '404':
          description: Profile not found
        '408':
          description: Test timeout

  /relay-profiles/{id}/preview:
    get:
      summary: Preview FFmpeg command (FR-017)
      description: |
        Returns the FFmpeg command that would be generated for this profile.
        Useful for debugging and manual testing.
      operationId: previewRelayProfile
      tags:
        - Relay Profiles
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: stream_url
          in: query
          required: false
          schema:
            type: string
          description: Optional stream URL for preview (uses placeholder if not provided)
      responses:
        '200':
          description: Command preview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandPreview'
        '404':
          description: Profile not found

  /relay-profiles/validate-flags:
    post:
      summary: Validate custom FFmpeg flags (FR-005)
      description: |
        Validates custom FFmpeg flags for syntax and security issues.
        Returns warnings for potentially dangerous patterns.
      operationId: validateFlags
      tags:
        - Relay Profiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                input_options:
                  type: string
                  maxLength: 1000
                output_options:
                  type: string
                  maxLength: 1000
                filter_complex:
                  type: string
                  maxLength: 2000
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FlagValidationResult'

  /hardware-capabilities:
    get:
      summary: Get detected hardware capabilities (FR-009)
      description: |
        Returns hardware acceleration capabilities detected at startup.
        Includes available encoders, decoders, and device information.
      operationId: getHardwareCapabilities
      tags:
        - Hardware
      responses:
        '200':
          description: Hardware capabilities
          content:
            application/json:
              schema:
                type: object
                properties:
                  capabilities:
                    type: array
                    items:
                      $ref: '#/components/schemas/HardwareCapability'
                  detected_at:
                    type: string
                    format: date-time
                  recommended:
                    $ref: '#/components/schemas/HardwareCapability'

  /hardware-capabilities/refresh:
    post:
      summary: Refresh hardware detection
      description: Re-detects available hardware acceleration capabilities
      operationId: refreshHardwareCapabilities
      tags:
        - Hardware
      responses:
        '200':
          description: Detection complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  capabilities:
                    type: array
                    items:
                      $ref: '#/components/schemas/HardwareCapability'
                  detected_at:
                    type: string
                    format: date-time

components:
  schemas:
    RelayProfile:
      type: object
      required:
        - id
        - name
        - video_codec
        - audio_codec
        - output_format
      properties:
        id:
          type: string
          description: ULID identifier
        name:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 500
        is_default:
          type: boolean
        enabled:
          type: boolean
        is_system:
          type: boolean
          description: System profiles can only have enabled toggled

        # Video settings
        video_codec:
          type: string
          enum: [copy, libx264, libx265, libvpx-vp9, libaom-av1, h264_nvenc, hevc_nvenc, h264_qsv, hevc_qsv, h264_vaapi, hevc_vaapi]
        video_bitrate:
          type: integer
          description: Video bitrate in kbps (0 = auto)
        video_maxrate:
          type: integer
        video_bufsize:
          type: integer
        video_width:
          type: integer
        video_height:
          type: integer
        video_framerate:
          type: number
        video_preset:
          type: string
        video_crf:
          type: integer
          minimum: 0
          maximum: 51
        video_profile:
          type: string
        video_level:
          type: string

        # Audio settings
        audio_codec:
          type: string
          enum: [copy, aac, libmp3lame, libopus, ac3, eac3]
        audio_bitrate:
          type: integer
        audio_sample_rate:
          type: integer
        audio_channels:
          type: integer

        # Hardware acceleration
        hw_accel:
          type: string
          enum: [none, cuda, qsv, vaapi, videotoolbox]
        hw_accel_device:
          type: string
          description: Device path or index
        hw_accel_output_format:
          type: string
          description: Memory format for hwaccel pipeline
        hw_accel_decoder_codec:
          type: string
          description: Hardware decoder codec
        hw_accel_extra_options:
          type: string
          maxLength: 500
        gpu_index:
          type: integer
          default: -1
          description: GPU index (-1 = auto)

        # Output settings
        output_format:
          type: string
          enum: [mpegts, hls, flv, matroska, mp4]
        segment_time:
          type: integer
        playlist_size:
          type: integer

        # Buffer settings
        input_buffer_size:
          type: integer
        output_buffer_size:
          type: integer
        probe_size:
          type: integer
        analyze_duration:
          type: integer
        timeout:
          type: integer

        # Custom options (FR-001, FR-002, FR-003)
        input_options:
          type: string
          maxLength: 1000
          description: Custom FFmpeg input flags
        output_options:
          type: string
          maxLength: 1000
          description: Custom FFmpeg output flags
        filter_complex:
          type: string
          maxLength: 2000
          description: Custom filter graph

        # Thread settings
        threads:
          type: integer
        thread_queue:
          type: integer

        # Fallback settings
        fallback_enabled:
          type: boolean
        fallback_error_threshold:
          type: integer
        fallback_recovery_interval:
          type: integer

        # Validation status (FR-005)
        custom_flags_validated:
          type: boolean
        custom_flags_warnings:
          type: array
          items:
            type: string

        # Statistics (FR-022)
        success_count:
          type: integer
        failure_count:
          type: integer
        last_used_at:
          type: string
          format: date-time
        last_error_at:
          type: string
          format: date-time
        last_error_msg:
          type: string

        # Timestamps
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateRelayProfileRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 500
        video_codec:
          type: string
          default: copy
        audio_codec:
          type: string
          default: copy
        hw_accel:
          type: string
          default: none
        hw_accel_device:
          type: string
        hw_accel_output_format:
          type: string
        hw_accel_decoder_codec:
          type: string
        gpu_index:
          type: integer
          default: -1
        output_format:
          type: string
          default: mpegts
        input_options:
          type: string
        output_options:
          type: string
        filter_complex:
          type: string
        # ... other optional fields

    UpdateRelayProfileRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        description:
          type: string
        enabled:
          type: boolean
        # All other profile fields are optional
        video_codec:
          type: string
        audio_codec:
          type: string
        hw_accel:
          type: string
        input_options:
          type: string
        output_options:
          type: string
        filter_complex:
          type: string
        # ... other optional fields

    ProfileTestResult:
      type: object
      required:
        - profile_id
        - profile_name
        - success
        - tested_at
      properties:
        profile_id:
          type: string
        profile_name:
          type: string
        test_stream_url:
          type: string
        test_duration:
          type: string
          description: Duration in Go duration format
        tested_at:
          type: string
          format: date-time
        success:
          type: boolean
        frames_processed:
          type: integer
        fps:
          type: number
        avg_bitrate:
          type: string
        detected_video_codec:
          type: string
        detected_audio_codec:
          type: string
        detected_resolution:
          type: string
        hw_accel_requested:
          type: boolean
        hw_accel_active:
          type: boolean
        hw_accel_device:
          type: string
        hw_accel_encoder:
          type: string
        hw_accel_decoder:
          type: string
        warnings:
          type: array
          items:
            type: string
        errors:
          type: array
          items:
            type: string
        suggestions:
          type: array
          items:
            type: string
        ffmpeg_output:
          type: string
          description: Raw FFmpeg stderr output (truncated)
        command_executed:
          type: string
          description: The FFmpeg command that was executed
        estimated_cpu_usage:
          type: number
        estimated_memory_mb:
          type: number

    CommandPreview:
      type: object
      required:
        - profile_id
        - profile_name
        - command
        - full_command
      properties:
        profile_id:
          type: string
        profile_name:
          type: string
        command:
          type: string
          description: FFmpeg binary path
        arguments:
          type: array
          items:
            type: string
          description: Command arguments as array
        full_command:
          type: string
          description: Complete command as single string for copying
        warnings:
          type: array
          items:
            type: string

    FlagValidationResult:
      type: object
      required:
        - valid
      properties:
        valid:
          type: boolean
          description: Whether flags pass validation
        flags:
          type: array
          items:
            type: string
          description: Parsed flags
        warnings:
          type: array
          items:
            type: string
          description: Validation warnings (non-blocking)
        errors:
          type: array
          items:
            type: string
          description: Validation errors
        suggestions:
          type: array
          items:
            type: string

    HardwareCapability:
      type: object
      required:
        - type
        - name
        - available
      properties:
        type:
          type: string
          enum: [none, cuda, nvdec, qsv, vaapi, videotoolbox, dxva2, d3d11va, vulkan]
        name:
          type: string
        available:
          type: boolean
        device_name:
          type: string
        device_path:
          type: string
        gpu_index:
          type: integer
        supported_encoders:
          type: array
          items:
            type: string
        supported_decoders:
          type: array
          items:
            type: string
        detected_at:
          type: string
          format: date-time

    ValidationError:
      type: object
      properties:
        error:
          type: string
        details:
          type: object
          additionalProperties:
            type: string
        suggestions:
          type: array
          items:
            type: string

tags:
  - name: Relay Profiles
    description: Relay profile management with custom flags and hardware acceleration
  - name: Hardware
    description: Hardware acceleration capability detection
