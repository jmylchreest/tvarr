name: Version Documentation

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate tag format
        run: |
          if [[ ! "${{ github.event.inputs.tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag must be in format v*.*.* (e.g., v1.0.0)"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: docs

      - name: Create version
        run: |
          VERSION="${{ github.event.inputs.tag }}"
          VERSION="${VERSION#v}"
          npm run docusaurus docs:version "$VERSION"
        working-directory: docs

      - name: Create versioned changelog entry
        run: |
          TAG="${{ github.event.inputs.tag }}"
          DATE=$(date +%Y-%m-%d)

          # Create the versioned changelog file from unreleased
          cat > docs/docs/changelog/${TAG}.md << EOF
          ---
          title: ${TAG}
          description: Release ${TAG}
          sidebar_position: 99
          ---

          # ${TAG}

          **Released:** ${DATE}

          $(grep -A 1000 "^## " docs/docs/changelog/unreleased.md | tail -n +1)
          EOF

          # Reset unreleased.md
          cat > docs/docs/changelog/unreleased.md << 'EOF'
          ---
          title: Unreleased
          description: Changes in development
          sidebar_position: 1
          ---

          # Unreleased

          Changes that will be included in the next release.

          ## Added

          - (Nothing yet)

          ## Changed

          - (Nothing yet)

          ## Fixed

          - (Nothing yet)

          ## Deprecated

          - (Nothing yet)

          ## Removed

          - (Nothing yet)

          ## Security

          - (Nothing yet)
          EOF

          # Update sidebar to include new changelog entry
          sed -i "s/'changelog\/unreleased',/'changelog\/unreleased',\n        'changelog\/${TAG}',/" docs/sidebars.ts

      - name: Commit versioned docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/versions.json docs/versioned_docs docs/versioned_sidebars docs/docs/changelog docs/sidebars.ts
          git commit -m "docs: version ${{ github.event.inputs.tag }}"
          git push

  deploy:
    needs: version
    uses: ./.github/workflows/docs.yml
