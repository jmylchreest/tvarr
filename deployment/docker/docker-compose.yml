# tvarr Docker Compose Configuration
#
# This compose file runs tvarr (coordinator) and tvarr-ffmpegd (transcoding daemon)
# as separate containers on a shared bridge network.
#
# Usage:
#   docker compose -f deployment/docker/docker-compose.yml up -d
#   docker compose -f deployment/docker/docker-compose.yml logs -f
#   docker compose -f deployment/docker/docker-compose.yml down
#
# Environment variables can be customized via a .env file or command line.

services:
  # =============================================================================
  # tvarr - Coordinator (distributed mode - relies on ffmpegd workers)
  # =============================================================================
  tvarr:
    image: ghcr.io/jmylchreest/tvarr-coordinator:latest
    restart: unless-stopped
    networks:
      - tvarr-net

    ports:
      # HTTP API and UI
      - "${TVARR_SERVER_PORT:-8080}:8080"
      # gRPC for ffmpegd connections (optional external exposure)
      # - "${TVARR_GRPC_PORT:-9090}:9090"

    environment:
      # User/Group mapping for volume permissions
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}

      # Server configuration
      - TVARR_SERVER_PORT=8080
      - TVARR_SERVER_BASE_URL=${TVARR_SERVER_BASE_URL:-}

      # gRPC server for ffmpegd connections
      - TVARR_GRPC_PORT=9090
      - TVARR_GRPC_ENABLED=true

      # Database
      - TVARR_DATABASE_DSN=${TVARR_DATABASE_DSN:-file:/data/tvarr.db}

      # Logging
      - TVARR_LOGGING_LEVEL=${TVARR_LOGGING_LEVEL:-info}

      # Storage
      - TVARR_STORAGE_BASE_DIR=/data

      # FFmpeg paths
      - TVARR_FFMPEG_BINARY_PATH=/usr/bin/ffmpeg
      - TVARR_FFMPEG_PROBE_PATH=/usr/bin/ffprobe

    volumes:
      # Persistent data storage
      - tvarr-data:/data

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3

  # =============================================================================
  # tvarr-ffmpegd - Transcoding daemon
  # =============================================================================
  ffmpegd:
    image: ghcr.io/jmylchreest/tvarr-transcoder:latest
    restart: unless-stopped
    networks:
      - tvarr-net

    # Wait for tvarr to start first
    depends_on:
      tvarr:
        condition: service_healthy

    environment:
      # User/Group mapping for GPU permissions
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}

      # Coordinator connection via Docker network DNS
      # 'tvarr' is the service name, resolved by Docker's internal DNS
      - TVARR_COORDINATOR_URL=tvarr:9090

      # Authentication (optional)
      - TVARR_AUTH_TOKEN=${TVARR_AUTH_TOKEN:-}

      # Daemon identification - leave empty to use container hostname (container ID)
      # The entrypoint will default to $(hostname) if not set
      - TVARR_DAEMON_NAME=${TVARR_DAEMON_NAME:-}

      # Maximum concurrent transcoding jobs
      - TVARR_MAX_JOBS=${TVARR_MAX_JOBS:-4}

      # Logging
      - TVARR_LOGGING_LEVEL=${TVARR_LOGGING_LEVEL:-info}

    # GPU access for hardware acceleration
    # Uncomment the appropriate section for your GPU type

    # Intel/AMD GPU (VAAPI)
    devices:
      - /dev/dri:/dev/dri

    # NVIDIA GPU - uncomment and configure
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu, video, compute]

    healthcheck:
      test: ["CMD", "pgrep", "-f", "tvarr-ffmpegd"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3

networks:
  tvarr-net:
    name: tvarr-net
    driver: bridge

volumes:
  tvarr-data:
    name: tvarr-data
